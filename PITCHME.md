# 「Subway Tooter」の紹介

2017-8-27 tateisu

---
### この資料で紹介すること
- 作者について
- アプリを作成した経緯
- アプリの設計について
- 別アカ操作
- 別アカ操作の技術的な詳細

---
### 作者について

- Subway Tooter の作者
- mastodon.juggler.jpのop
- juggler IRC serviceのop
- 2ch@IRCの3鯖のopだったが、2chの御家騒動に巻き込まれて脱退
- QuickIRC2 (JavaScript+Flash のIRCクライアント ) の開発
- Blunt IRC (JavaのIRCクライアント) の開発
- 今の本業は雇われのAndroidアプリ開発者
- 睡眠障害持ち

---
### アプリを作成した経緯

- 2017年4月12日16時(JST)ごろに mastdon.juggler.jp を運用開始。初めて見たTLは自タンスの空のTLだった
- その後一週間くらいタンス運用で苦労する
- 公式Webやクライアントの使い勝手に満足できなかったのでアプリを書き始める
- 同年4月23日17時(JST)ごろに Subway Tooter をPlayストアで公開
- (某所の「アプリを最速でリリースした話」よりさらに早い&速い)

---
### アプリの設計について
- 「Everything is column」
- 「より低コストに」
- 「できることを増やす」

次ページ以降でそれぞれ説明します

---
### 「Everything is column」 1/2

Pros:
- サーバから情報を取得して表示するビューの殆どをカラムとして扱う
- WebブラウザのタブやEmacsのバッファと同じくらい一貫した操作性と利便性
- 画面構成で悩まない
- 新しい画面を追加する時に導線で悩まない

---
### 「Everything is column」 2/2

Cons:
- 万人向けとは言い難い
- ユーザが意識する機能（たとえば通知や検索）への導線がトップ画面上に存在しない。くっそ長いメニューを見ないと機能を発見できない

---
### 「より低コストに」

Pros:
- Mastodonがいつ廃れるか分からなかった
- 新機能を追加するコストが低い
- 物凄い安普請 => 低コスト化に貢献
- 物凄い雑で無頓着なデザイン => 低コスト化に貢献

---
### 「より低コストに」

Cons:
- 安普請の結果、AdapterView絡みのいくつかの不具合を解決できていない
- デザイン面は合わない人にはとことん合わないらしい
- 画像や動画のメディアビューアを内蔵していない
- アプリ開発者の技術アピールとしては見た目が悪いのは問題

---
### 「できることを増やす」

- 恐らく現時点で最も多機能なアプリ
- 多機能は必ずしも「使いやすい」を意味しない
- カラム別のカスタマイズ
- タンス間スコップへの最適化。疑似アカウントや別アカ操作
- タブレットでの複数カラム同時表示。モバイルOSだとたぶんまだSTだけ

機能は他にも色々あるので公式blogを参照してください

http://subwaytooter.hatenadiary.jp/

---
### タンス間スコップ 1/3

零細タンスを作った管理者ならみんな経験があると思ってますが、

他のタンスからトゥートやユーザをスコップしてフォロー、ファボ、ブーストをしないとTLが寂しいままです。

管理者じゃなくても同じようなことを感じた人はいるかもしれません

---
### タンス間スコップ 2/3

この作業を「タンス間スコップ」と呼んでいます。

タンス間スコップを快適にするには

- リモートフォローをより少ない手数で行える
- ローカルにないトゥートへのファボ/ブースト/返信をより少ない手数で行える

---
### タンス間スコップ 3/3

Subway Tooter ではタンス間スコップを積極的にサポートしてます。

- アプリ設定を変更するとTL上にフォローボタンを直接表示できます
- 「別アカウントで～」という「別アカ操作」を各種用意しています
- タンス毎にアカウントを作らなくても「疑似アカウント」で代用できます

---
### 別アカ操作 1/3

トゥートに対する別アカウント操作
- 別アカウントでお気に入り/ブースト/返信/会話ビューを開く
- 疑似アカウントで会話ビューを開く。(1.2.2から)

---
### 別アカ操作 2/3

ユーザに対する別アカウント操作
- 別アカウントでフォロー/メッセージを送る/プロフを開く

---
### 別アカ操作 3/3

制約によりできないこと
- 疑似アカウントでプロフを開く。ユーザアカウントの取得やユーザが作成したトゥート一覧の取得のAPIにはアクセストークンが必要になるため、疑似アカウントではプロフを開けません。

---
### 別アカ操作の技術的な詳細 1/4

リモートにあるデータをローカルに持ってくる
- Mastodonの検索APIにアカウントやトゥートのURLをぶちこむと出来ます。
- フォロー/ファボ/ブースト/返信する主体は実アカウントなので検索APIを利用可能です。

---
### 別アカ操作の技術的な詳細 2/4

リモートから流れてきたトゥートの発言元タンスでのステータスIDを調べる
- 発言元タンスのアクセストークンを持っているとは限らない
- トゥートのuriがOStatusなら、APIから取得したデータのuriが 正規表現 tag:([^,]*),[^:]*:objectId=(\d+):objectType=Status にマッチすればステータスIDを取得できます。
- トゥートのuriがActivityPubの場合はどうなるかまだ分かりません

---
### 別アカ操作の技術的な詳細 3/4
リモートから流れてきたトゥートの発言元タンスでのステータスIDを調べる
- トゥートの公開URLのHTMLが正規表現 <a\b[^>]*?\bdetailed-status__datetime\b[^>]*href=\"https://[^/]+/@[^/]+/(\d+)\" にマッチすればステータスIDを取得できます

---
### 別アカ操作の技術的な詳細 4/4

できないこと：リモートのアカウントのusernameから元タンスでのアカウントIDを調べる
- 元タンスのアクセストークンを持っているとは限らない
- 検索APIはアクセストークンがないと利用できない
- MastodonのIssues #4588 にも挙がってはいるが…

---
### おわり

- 質疑応答

- 連絡先： @tateisu@mastodon.juggler.jp
